# Wazuh Full Stack - Manager + Indexer + Dashboard
# fly.toml app configuration file for ai2-wazuh
# Single app deployment for cost efficiency
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
# embracingearth.space

app = "ai2-wazuh"
primary_region = "syd"
kill_signal = "SIGTERM"
kill_timeout = "30s"

[build]
  dockerfile = "Dockerfile.fullstack"
  build_args = { WAZUH_VERSION = "4.8.0" }

[env]
  NODE_ENV = "production"
  # Wazuh API credentials - MUST be set via fly secrets!
  # WAZUH_API_USER and WAZUH_API_PASSWORD are set via: fly secrets set

[experimental]
  auto_rollback = true

# Dashboard exposed on port 443 (HTTPS) -> internal port 5601
# Using [[services]] format for TCP health check support
# Manager API (port 55000) accessible via Fly.io internal networking
[[services]]
  internal_port = 5601
  protocol = "tcp"
  auto_stop_machines = "off"    # REQUIRED: Indexer needs 10+ min to start
  auto_start_machines = true
  min_machines_running = 0
  processes = ["wazuh"]

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  [[services.ports]]
    port = 80
    handlers = ["http"]
    force_https = true

  # HTTP health check - uses root path / which redirects to /app/login (302)
  # Dashboard takes 12-17 minutes to fully start (Indexer: 10-15min + Dashboard: 1-2min)
  # NOTE: Fly.io caps grace_period at 1 minute - health check will fail initially
  # Once Dashboard is ready (after 12-17 min), health check will pass
  # Health checks hit internal_port (5601) directly with HTTP, not through TLS proxy
  # IMPORTANT: Health checks will show "connection refused" until Dashboard starts (12-17 min)
  # This is expected - Fly.io will route traffic once health checks pass
  # Root path / doesn't require authentication and returns 302 redirect when Dashboard is running
  # This is simpler and more reliable than /api/status which requires auth (returns 401)
  [[services.http_checks]]
    grace_period = "1m"         # Max allowed by Fly.io
    interval = "10s"            # Check every 10s (faster detection once ready)
    timeout = "15s"             # 15s timeout (Dashboard can be slow during startup)
    method = "GET"
    path = "/"                  # Root path - returns 302 redirect to /app/login (no auth required)
    protocol = "http"           # HTTP on internal port 5601 (TLS terminates at proxy)
    tls_skip_verify = false
    # Accept 200 (if Dashboard serves root), 302/301/303/307/308 (redirects), and 401 (fallback)
    # 302 redirect means Dashboard is running and responding - that's healthy!
    success_codes = [200, 301, 302, 303, 307, 308, 401]
  
  # TCP health check as fallback - verifies port is open
  # This ensures health check passes even if HTTP check has issues
  # TCP check is simpler and might pass earlier than HTTP check
  # Useful during Dashboard startup when HTTP might not be ready yet
  [[services.tcp_checks]]
    grace_period = "1m"         # Max allowed by Fly.io
    interval = "10s"            # Check every 10s (faster detection once ready)
    timeout = "5s"              # 5s timeout (TCP connection is fast)

# Note: Manager API (port 55000) is accessible via Fly.io internal networking
# Other apps in same organization can access: https://ai2-wazuh.internal:55000
# This is more secure than exposing Manager API publicly

# Process definition
[processes]
  # /start.sh runs init scripts (certs, configs) then starts supervisord
  wazuh = "/start.sh"

[[vm]]
  memory = "3gb"              # 3GB total - Indexer: ~1.5GB, Manager: ~512MB, Dashboard: ~512MB, System: ~500MB
  cpu_kind = "shared"
  cpus = 2                    # 2 CPUs for better performance with all services

# Volume mounts for data persistence
# All Wazuh data stored in single volume (subdirectories)
[mounts]
  source = "wazuh_data"
  destination = "/var/ossec/data"
  # Note: Indexer data (/var/lib/wazuh-indexer) and Dashboard data (/var/lib/wazuh-dashboard)
  # will be stored in the same volume but in different subdirectories
  # For production, consider separate volumes for better isolation
