# Wazuh Full Stack - Manager + Indexer + Dashboard
# fly.toml app configuration file for ai2-wazuh
# Single app deployment for cost efficiency
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
# embracingearth.space

app = "ai2-wazuh"
primary_region = "syd"
kill_signal = "SIGTERM"
kill_timeout = "30s"

[build]
  dockerfile = "Dockerfile.fullstack"
  build_args = { WAZUH_VERSION = "4.8.0" }

[env]
  NODE_ENV = "production"
  # Wazuh API credentials - MUST be set via fly secrets!
  # WAZUH_API_USER and WAZUH_API_PASSWORD are set via: fly secrets set

[experimental]
  auto_rollback = true

# Modern Fly.io http_service configuration
# Dashboard is the main service exposed (port 5601)
# Manager API (port 55000) accessible via Fly.io internal networking
# Core app should use: https://ai2-wazuh.internal:55000
[http_service]
  internal_port = 5601        # Dashboard port (main access point)
  force_https = true
  auto_stop_machines = "stop"   # Cost optimization: allow full stop
  auto_start_machines = true    # Auto-start on request
  min_machines_running = 0      # Cost optimization: no minimum
  processes = ["wazuh"]

  # Health check for Dashboard
  # NOTE: Cold starts take 6-8 minutes (Indexer initialization is slow)
  # Dashboard returns 302 redirect on root path, not 200
  # Using TCP check since HTTP checks don't support success_codes in Fly.io
  [[http_service.checks]]
    interval = "60s"          # Check every minute
    timeout = "30s"           # Allow 30s for response
    grace_period = "60s"      # Maximum allowed by Fly.io
    protocol = "tcp"          # TCP check: just verify port 5601 is open

# Note: Manager API (port 55000) is accessible via Fly.io internal networking
# Other apps in same organization can access: https://ai2-wazuh.internal:55000
# This is more secure than exposing Manager API publicly

# Process definition
[processes]
  # Supervisord manages all three services (Manager, Indexer, Dashboard)
  wazuh = "/usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf"

[[vm]]
  memory = "4gb"              # Full stack needs 4GB (Manager: 1GB, Indexer: 2GB, Dashboard: 1GB)
  cpu_kind = "shared"
  cpus = 2                    # 2 CPUs for better performance with all services

# Volume mounts for data persistence
# All Wazuh data stored in single volume (subdirectories)
[mounts]
  source = "wazuh_data"
  destination = "/var/ossec/data"
  # Note: Indexer data (/var/lib/wazuh-indexer) and Dashboard data (/var/lib/wazuh-dashboard)
  # will be stored in the same volume but in different subdirectories
  # For production, consider separate volumes for better isolation
