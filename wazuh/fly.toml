# Wazuh Full Stack - Manager + Indexer + Dashboard
# fly.toml app configuration file for ai2-wazuh
# Single app deployment for cost efficiency
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
# embracingearth.space

app = "ai2-wazuh"
primary_region = "syd"
kill_signal = "SIGTERM"
kill_timeout = "30s"

[build]
  dockerfile = "Dockerfile.fullstack"
  build_args = { WAZUH_VERSION = "4.8.0" }

[env]
  NODE_ENV = "production"
  # Wazuh API credentials - MUST be set via fly secrets!
  # WAZUH_API_USER and WAZUH_API_PASSWORD are set via: fly secrets set

[experimental]
  auto_rollback = true

# Dashboard exposed on port 443 (HTTPS) -> internal port 5601
# IMPORTANT: Use Fly's `http_service` so routing is HTTP-based (not `tcp/443`),
# otherwise Fly-proxy may ignore http_checks and require tcp_checks (which proved flaky here).
# Manager API (port 55000) accessible via Fly.io internal networking
[http_service]
  internal_port = 5601
  auto_stop_machines = "off"    # REQUIRED: Indexer needs 10+ min to start
  auto_start_machines = true
  min_machines_running = 1
  processes = ["wazuh"]
  force_https = true

  # Fly health check: Dashboard status endpoint
  # [[http_service.checks]]
  #   grace_period = "120s"  # Give plenty of time for Indexer + Dashboard to start
  #   interval = "15s"
  #   timeout = "5s"
  #   method = "GET"
  #   path = "/api/status"

# Note: Manager API (port 55000) is accessible via Fly.io internal networking
# Other apps in same organization can access: https://ai2-wazuh.internal:55000
# This is more secure than exposing Manager API publicly
#
# Wazuh Agent Port (1514) - For agents to connect and send security events
# Accessible via internal network only (ai2-wazuh.internal:1514)
[[services]]
  internal_port = 1514
  protocol = "tcp"
  auto_stop_machines = "off"
  auto_start_machines = true
  processes = ["wazuh"]
  
  # Expose on internal network only for security
  [[services.ports]]
    port = 1514
    handlers = []  # No TLS/HTTP, raw TCP

# Process definition
[processes]
  # /start.sh runs init scripts (certs, configs) then starts supervisord
  wazuh = "/start.sh"

[[vm]]
  # 4GB for stable Indexer+Dashboard+Manager operation under load
  # Indexer: ~1.5GB, Manager: ~512MB, Dashboard: ~512MB, System: ~500MB
  memory = "4gb"
  cpu_kind = "shared"
  cpus = 2
  # CRITICAL: Increased disk size to prevent read-only blocks
  # Root filesystem was 100% full causing OpenSearch to block writes
  disk_gb = 20

# Volume mounts for data persistence
# All Wazuh data stored in single volume (subdirectories)
[mounts]
  source = "wazuh_data"
  destination = "/var/ossec/data"
  # Note: Indexer data (/var/lib/wazuh-indexer) and Dashboard data (/var/lib/wazuh-dashboard)
  # will be stored in the same volume but in different subdirectories
  # For production, consider separate volumes for better isolation
