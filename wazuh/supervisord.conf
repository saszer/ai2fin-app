# Wazuh Full Stack Supervisord Configuration
# SIMPLIFIED ARCHITECTURE: Dashboard binds directly to port 5601
# No Nginx proxy or custom health server needed
# embracingearth.space
# Force rebuild 2026-01-02-02

# API user creation is handled by cont-init.d/12-delayed-api-user.sh
# which launches a background script that waits for Manager to be ready

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:nginx-proxy]
# Public entrypoint on 5601 (Fly internal_port). Routes /health → health server, / → Dashboard (5602).
# CRITICAL: Must bind to 0.0.0.0 and :: (configured in scripts/nginx-health-proxy.conf)
command=/usr/sbin/nginx -g "daemon off;" -c /etc/nginx/nginx.conf
autostart=true
autorestart=true
startretries=10
startsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
priority=40
stopasgroup=true
killasgroup=true

[program:health-check-server]
# Health endpoint for Fly checks. Starts immediately; keeps routing stable during long Indexer/Dashboard startup.
command=/usr/bin/python3 /etc/cont-init.d/scripts/health-check-server.py
autostart=true
autorestart=true
startretries=10
startsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
priority=50
stopasgroup=true
killasgroup=true

[program:wazuh-manager]
command=/bin/bash -c "set +e; /var/ossec/bin/wazuh-control start; sleep 5; while true; do if [ -f /var/ossec/logs/ossec.log ]; then tail -f /var/ossec/logs/ossec.log; else sleep 5; fi; done"
autostart=true
autorestart=true
startretries=5
startsecs=15
stdout_logfile=/var/log/supervisor/wazuh-manager.log
stderr_logfile=/var/log/supervisor/wazuh-manager.err
user=root
priority=100
stopasgroup=true
killasgroup=true

[program:wazuh-indexer]
# Enhanced error handling and logging for Indexer startup
# Use wrapper script to capture all errors
# Log to stdout/stderr so fly logs can capture it
# CRITICAL: Run as root initially to set up permissions, then switch to wazuh-indexer
# OpenSearch security bootstrap needs access to parent directories
command=/bin/bash /etc/cont-init.d/scripts/run-indexer-with-logging.sh
autostart=true
autorestart=true
startretries=10
startsecs=60
# Log to stdout/stderr so fly logs can see it
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
directory=/usr/share/wazuh-indexer
# CRITICAL: Use /tmp for temp directory - Fly.io volumes don't support user switching
# Volume mounts have restrictions that prevent sudo -u from working
# /tmp is on root filesystem and supports user switching properly
# OpenSearch uses OPENSEARCH_JAVA_OPTS, not JAVA_OPTS
environment=OPENSEARCH_HOME="/usr/share/wazuh-indexer",OPENSEARCH_PATH_CONF="/etc/wazuh-indexer",JAVA_HOME="/usr/share/wazuh-indexer/jdk",TMPDIR="/tmp/wazuh-indexer-tmp",OPENSEARCH_JAVA_OPTS="-Djava.io.tmpdir=/tmp/wazuh-indexer-tmp"
priority=200
stopasgroup=true
killasgroup=true
stopwaitsecs=30

[program:wazuh-dashboard]
# Wait for Indexer to be ready AND security index initialized, then start Dashboard
# With security enabled, Indexer requires admin credentials AND security index must be initialized
# allow_default_init_securityindex: true creates admin user, but it takes time
# NOTE: Running as root to allow securityadmin execution, then switches to wazuh-dashboard
# Nginx proxy architecture: Dashboard listens on 5602, nginx listens on 5601 and proxies traffic.
command=/bin/bash /etc/cont-init.d/scripts/wait-for-indexer-and-start-dashboard.sh
autostart=true
autorestart=true
startretries=10
startsecs=90
# Log to stdout/stderr so fly logs can capture it (for debugging)
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Also keep a backup log file
stdout_capture_maxbytes=50MB
stderr_capture_maxbytes=50MB
# Run as root to allow securityadmin execution (startup script switches to dashboard user)
user=root
directory=/usr/share/wazuh-dashboard
# Enhanced environment variables for better stability
environment=OPENSEARCH_DASHBOARDS_HOME="/usr/share/wazuh-dashboard",OPENSEARCH_DASHBOARDS_PATH_CONF="/etc/wazuh-dashboard",NODE_OPTIONS="--max-old-space-size=1024",NODE_ENV="production"
priority=300
stopasgroup=true
killasgroup=true
# Wait longer before considering it failed
stopwaitsecs=30

# NOTE: Removed nginx-proxy and health-check-server
# SIMPLIFIED ARCHITECTURE: Dashboard binds directly to port 5601
# This ensures Fly.io can detect the service during deployment scan
# Health checks will fail during startup (15-20 min) but will pass once Dashboard is ready

[program:filebeat]
# Filebeat ships Wazuh alerts to Indexer
command=filebeat -e -c /etc/filebeat/filebeat.yml
autostart=true
autorestart=true
priority=10
startretries=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
