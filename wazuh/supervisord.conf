[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:wazuh-manager]
command=/bin/bash -c "set +e; /var/ossec/bin/wazuh-control start; sleep 5; while true; do if [ -f /var/ossec/logs/ossec.log ]; then tail -f /var/ossec/logs/ossec.log; else sleep 5; fi; done"
autostart=true
autorestart=true
startretries=5
startsecs=15
stdout_logfile=/var/log/supervisor/wazuh-manager.log
stderr_logfile=/var/log/supervisor/wazuh-manager.err
user=root
priority=100
stopasgroup=true
killasgroup=true

[program:wazuh-indexer]
# Enhanced error handling and logging for Indexer startup
# Use wrapper script to capture all errors
# Log to stdout/stderr so fly logs can capture it
# CRITICAL: Run as root initially to set up permissions, then switch to wazuh-indexer
# OpenSearch security bootstrap needs access to parent directories
command=/bin/bash /etc/cont-init.d/scripts/run-indexer-with-logging.sh
autostart=true
autorestart=true
startretries=10
startsecs=60
# Log to stdout/stderr so fly logs can see it
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
directory=/usr/share/wazuh-indexer
# CRITICAL: Use /tmp for temp directory - Fly.io volumes don't support user switching
# Volume mounts have restrictions that prevent sudo -u from working
# /tmp is on root filesystem and supports user switching properly
# OpenSearch uses OPENSEARCH_JAVA_OPTS, not JAVA_OPTS
environment=OPENSEARCH_HOME="/usr/share/wazuh-indexer",OPENSEARCH_PATH_CONF="/etc/wazuh-indexer",JAVA_HOME="/usr/share/wazuh-indexer/jdk",TMPDIR="/tmp/wazuh-indexer-tmp",OPENSEARCH_JAVA_OPTS="-Djava.io.tmpdir=/tmp/wazuh-indexer-tmp"
priority=200
stopasgroup=true
killasgroup=true
stopwaitsecs=30

[program:wazuh-dashboard]
# Wait for Indexer to be ready AND security index initialized, then start Dashboard
# With security enabled, Indexer requires admin credentials AND security index must be initialized
# allow_default_init_securityindex: true creates admin user, but it takes time
command=/bin/bash /etc/cont-init.d/scripts/wait-for-indexer-and-start-dashboard.sh
autostart=true
autorestart=true
startretries=10
startsecs=90
# Log to stdout/stderr so fly logs can capture it (for debugging)
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
# Also keep a backup log file
stdout_capture_maxbytes=50MB
stderr_capture_maxbytes=50MB
user=wazuh-dashboard
directory=/usr/share/wazuh-dashboard
# Enhanced environment variables for better stability
environment=OPENSEARCH_DASHBOARDS_HOME="/usr/share/wazuh-dashboard",OPENSEARCH_DASHBOARDS_PATH_CONF="/etc/wazuh-dashboard",NODE_OPTIONS="--max-old-space-size=1024",NODE_ENV="production"
priority=300
stopasgroup=true
killasgroup=true
# Wait longer before considering it failed
stopwaitsecs=30

[program:health-check-server]
# Custom health check server that runs detailed sub-checks internally
# but returns simple pass/fail to Fly.io health checks
# This allows Fly.io health check to pass even during startup
# Health check server listens on port 8080
# Nginx proxy on port 5601 routes /health to this server
# embracingearth.space
command=/usr/bin/python3 /etc/cont-init.d/scripts/health-check-server.py
autostart=true
autorestart=true
startretries=5
startsecs=5
# Log to stdout/stderr so fly logs can capture it
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
priority=50
stopasgroup=true
killasgroup=true

[program:nginx-proxy]
# Nginx reverse proxy on port 5601
# Routes /health to health check server (port 8080)
# Routes everything else to Dashboard (port 5602)
# This allows both health check and Dashboard to work on port 5601
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
startretries=5
startsecs=5
# Log to stdout/stderr so fly logs can capture it
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
user=root
priority=40
stopasgroup=true
killasgroup=true

