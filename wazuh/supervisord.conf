[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:wazuh-manager]
command=/bin/bash -c "set +e; /var/ossec/bin/wazuh-control start; sleep 5; while true; do if [ -f /var/ossec/logs/ossec.log ]; then tail -f /var/ossec/logs/ossec.log; else sleep 5; fi; done"
autostart=true
autorestart=true
startretries=5
startsecs=15
stdout_logfile=/var/log/supervisor/wazuh-manager.log
stderr_logfile=/var/log/supervisor/wazuh-manager.err
user=root
priority=100
stopasgroup=true
killasgroup=true

[program:wazuh-indexer]
command=/bin/bash -c "if [ -f /usr/share/wazuh-indexer/bin/opensearch ]; then cd /usr/share/wazuh-indexer && ./bin/opensearch; elif [ -f /usr/bin/wazuh-indexer ]; then /usr/bin/wazuh-indexer; else echo 'ERROR: Indexer binary not found' && exit 1; fi"
autostart=true
autorestart=true
startretries=5
startsecs=30
stdout_logfile=/var/log/supervisor/wazuh-indexer.log
stderr_logfile=/var/log/supervisor/wazuh-indexer.err
user=wazuh-indexer
directory=/usr/share/wazuh-indexer
environment=OPENSEARCH_HOME="/usr/share/wazuh-indexer",OPENSEARCH_PATH_CONF="/etc/wazuh-indexer",JAVA_HOME="/usr/share/wazuh-indexer/jdk"
priority=200
stopasgroup=true
killasgroup=true

[program:wazuh-dashboard]
# Wait for Indexer to be ready, then start Dashboard with better error handling
# Exit status 64 usually indicates config/connection errors - adding retry logic
command=/bin/bash -c "set +e; echo 'Waiting for Indexer to be ready...'; MAX_WAIT=120; ELAPSED=0; while [ $ELAPSED -lt $MAX_WAIT ]; do if curl -s -f http://localhost:9200/_cluster/health > /dev/null 2>&1; then echo 'âœ“ Indexer is ready'; break; fi; sleep 5; ELAPSED=$((ELAPSED + 5)); done; sleep 10; echo 'Starting Wazuh Dashboard...'; if [ -f /usr/share/wazuh-dashboard/bin/opensearch-dashboards ]; then cd /usr/share/wazuh-dashboard && exec ./bin/opensearch-dashboards; elif [ -f /usr/bin/wazuh-dashboard ]; then exec /usr/bin/wazuh-dashboard; else echo 'ERROR: Dashboard binary not found' && exit 1; fi"
autostart=true
autorestart=true
startretries=10
startsecs=90
# Increase buffer size for better logging
stdout_logfile=/var/log/supervisor/wazuh-dashboard.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/var/log/supervisor/wazuh-dashboard.err
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
# Capture both stdout and stderr in main log
stdout_capture_maxbytes=50MB
stderr_capture_maxbytes=50MB
user=wazuh-dashboard
directory=/usr/share/wazuh-dashboard
# Enhanced environment variables for better stability
environment=OPENSEARCH_DASHBOARDS_HOME="/usr/share/wazuh-dashboard",OPENSEARCH_DASHBOARDS_PATH_CONF="/etc/wazuh-dashboard",NODE_OPTIONS="--max-old-space-size=1024",NODE_ENV="production"
priority=300
stopasgroup=true
killasgroup=true
# Wait longer before considering it failed
stopwaitsecs=30

