# Nginx reverse proxy for health check server
# Routes /health to health check server (port 8080)
# Routes everything else to Dashboard (port 5602, Dashboard will listen here)
# This allows both health check and Dashboard to work on port 5601
# embracingearth.space

events {
    worker_connections 1024;
}

http {
    # Health check server upstream (port 8080)
    upstream health_check {
        server 127.0.0.1:8080;
    }
    
    # Dashboard upstream (port 5602 - Dashboard will be configured to listen here)
    upstream dashboard {
        server 127.0.0.1:5602;
    }
    
    server {
        listen 0.0.0.0:5601;    # CRITICAL: Bind to all interfaces, not just localhost
        server_name _;
        
        # Health check endpoint - route to health check server
        location /health {
            proxy_pass http://health_check;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # All other requests - route to Dashboard
        location / {
            proxy_pass http://dashboard;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Handle Dashboard not ready yet (during startup)
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
            proxy_next_upstream error timeout http_502 http_503;
        }
    }
}

