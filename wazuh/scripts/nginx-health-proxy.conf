# Nginx reverse proxy for health check server
# Routes /health to health check server (port 8080)
# Routes everything else to Dashboard (port 5602, Dashboard will listen here)
# This allows both health check and Dashboard to work on port 5601
# embracingearth.space

events {
    worker_connections 1024;
}

http {
    # Health check server upstream (port 8080)
    upstream health_check {
        server 127.0.0.1:8080;
    }
    
    # Dashboard upstream (port 5602 - Dashboard will be configured to listen here)
    upstream dashboard {
        server 127.0.0.1:5602;
    }
    
    server {
        # CRITICAL: Bind to all interfaces (Fly proxy requires this). Also bind IPv6 for Fly 6PN.
        listen 0.0.0.0:5601;
        listen [::]:5601;
        server_name _;

        # Health check endpoint - route to health check server
        location /health {
            proxy_pass http://health_check;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # All other requests - route to Dashboard
        location / {
            proxy_pass http://dashboard;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Handle Dashboard not ready yet (during startup)
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
            proxy_next_upstream error timeout http_502 http_503;

            # If Dashboard isn't ready yet, don't hard-fail the public URL.
            # Return a simple "starting" page instead of 502/503.
            proxy_intercept_errors on;
            error_page 502 503 504 =200 /starting.html;
        }

        location = /starting.html {
            default_type text/html;
            add_header Cache-Control "no-store";
            return 200 "<html><head><title>Wazuh starting</title></head><body><h3>Wazuh UI is startingâ€¦</h3><p>Please retry in 1-3 minutes.</p><p>embracingearth.space</p></body></html>";
        }
    }
}

