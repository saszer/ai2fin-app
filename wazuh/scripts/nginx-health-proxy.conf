# Nginx reverse proxy for health check server
# Routes /health to health check server (port 8080)
# Routes everything else to Dashboard (port 5602, Dashboard will listen here)
# This allows both health check and Dashboard to work on port 5601
# embracingearth.space

events {
    worker_connections 1024;
}

http {
    # Logging format for debugging proxy issues
    log_format proxy_debug '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'upstream: $upstream_addr response_time: $upstream_response_time';
    
    # Access log (minimal to avoid disk space issues, but useful for debugging)
    access_log /var/log/nginx/access.log proxy_debug;
    error_log /var/log/nginx/error.log warn;
    
    # Health check server upstream (port 8080)
    upstream health_check {
        server 127.0.0.1:8080;
    }
    
    # Dashboard upstream (port 5602 - Dashboard will be configured to listen here)
    # CRITICAL FIX: Keepalive connections to prevent connection errors
    upstream dashboard {
        server 127.0.0.1:5602;
        keepalive 32;  # Maintain persistent connections to Dashboard
        keepalive_requests 100;  # Reuse connections for multiple requests
        keepalive_timeout 60s;  # Keep connections alive for 60s
    }
    
    server {
        # CRITICAL: Bind to all interfaces (Fly proxy requires this). Also bind IPv6 for Fly 6PN.
        listen 0.0.0.0:5601;
        listen [::]:5601;
        server_name _;

        # Fly health check endpoint (always fast + always 200).
        # This prevents Fly from marking the machine unhealthy during long Indexer/Dashboard startup.
        # IMPORTANT: This does NOT mean the Dashboard is ready; it only means nginx is reachable.
        # embracingearth.space
        location = /fly-health {
            default_type text/plain;
            add_header Cache-Control "no-store";
            return 200 "ok\n";
        }

        # Health check endpoint - route to health check server
        location /health {
            proxy_pass http://health_check;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # CRITICAL FIX: Optimized handling for UI static assets (fonts, logos, JS bundles)
        # These need proper buffering and caching to prevent 9-byte truncated responses
        location ~ ^/ui/ {
            proxy_pass http://dashboard;
            
            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # HTTP/1.1 for proper connection handling
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Aggressive buffering for static assets
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 16 8k;
            proxy_busy_buffers_size 16k;
            proxy_max_temp_file_size 0;
            
            # Longer timeouts for large assets (fonts, JS bundles can be large)
            proxy_connect_timeout 30s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
            
            # Cache static assets (Dashboard sets its own cache headers, but we can add ours too)
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            
            # Error handling
            proxy_intercept_errors on;
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # All other requests - route to Dashboard
        location / {
            proxy_pass http://dashboard;
            
            # CRITICAL: Preserve original request headers for Dashboard routing
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # CRITICAL FIX: HTTP/1.1 for proper connection handling (prevents 9-byte truncated responses)
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # CRITICAL FIX: Buffering settings to prevent truncated responses
            # Disable buffering for streaming responses, but enable for static files
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            proxy_max_temp_file_size 0;  # Disable temp files to prevent disk I/O issues
            
            # CRITICAL FIX: Increased timeouts for large static files (fonts, JS bundles, etc.)
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Handle Dashboard not ready yet (during startup)
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;

            # If Dashboard isn't ready yet, don't hard-fail the public URL.
            # Return a simple "starting" page instead of 502/503.
            proxy_intercept_errors on;
            error_page 502 503 504 =200 /starting.html;
            
            # CRITICAL FIX: Disable request body buffering for large uploads (if any)
            client_max_body_size 100m;
        }

        location = /starting.html {
            default_type text/html;
            add_header Cache-Control "no-store";
            return 200 "<html><head><title>Wazuh starting</title></head><body><h3>Wazuh UI is startingâ€¦</h3><p>Please retry in 1-3 minutes.</p><p>embracingearth.space</p></body></html>";
        }
    }
}

